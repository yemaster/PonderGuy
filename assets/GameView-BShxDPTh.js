var K=Object.defineProperty;var ee=(h,e,t)=>e in h?K(h,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):h[e]=t;var a=(h,e,t)=>(ee(h,typeof e!="symbol"?e+"":e,t),t);import{q as te,o as V,a as B,g as _,d as se,f as z,l as ie,m as oe,F as H,b as W,h as Q,j as ne,n as re,E as ae,p as le,x as ce,y as he}from"./index-Cg0EeqSd.js";import{V as v,Q as de,a as ue,b as pe,M as q,h as ge,q as fe,r as me,s as be,C as we,B as ye,e as I,k as je,S as ke,m as Pe,A as Ce,D as xe,d as U,W as Ee,p as ve}from"./methods-CyI6_l-K.js";import{R as Se,a as De,C as Me,M as Ae,D as _e,b as Te,P as Le,O as ze}from"./picker-Cknh9IdP.js";import{u as f}from"./constants-BDoWXNhu.js";import{u as Oe}from"./index-Ds1QSJAm.js";import{a as Re}from"./axios-DmY7Om-x.js";import{_ as Z}from"./_plugin-vue_export-helper-DlAUqK2U.js";class N{constructor(e,t){a(this,"x");a(this,"y");a(this,"vis",!1);this.x=e||0,this.y=t||0}fromArray(e){return(e.length===3||e.length===4)&&(this.x=-e[1]+e[2],this.y=e[0]-e[1]),this}fromVector3(e){return this.fromArray([e.x,e.y,e.z])}manhattanDist(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}equal(e,t){return typeof e=="number"&&t!==void 0?this.x===e&&this.y===t:typeof e!="number"?this.x===e.x&&this.y===e.y:!1}toVector3(){return new v(this.y+10,10,this.x+10)}}function X(h){const e=[];return h.forEach(t=>{if(t.isGroup){let s,i,r;const u=[new v(1,0,0),new v(0,1,0),new v(0,0,1)];switch(t.objectType){case"Cube":e.push([t.pos[0],t.pos[1],t.pos[2]]);break;case"Drawbox":for(let n=0;n<t.len[0];++n)for(let k=0;k<t.len[1];++k)for(let m=0;m<t.len[2];++m)e.push([t.pos[0]+n,t.pos[1]+k,t.pos[2]+m]);break;case"Rotator":s=new v,i=new v,s[t.face[0][1]]=t.face[0][0]==="-"?-1:1,i[t.face[1][1]]=t.face[1][0]==="-"?-1:1,r=new de().setFromAxisAngle(u[t.direction],t.angle*Math.PI/2),s.applyQuaternion(r).round(),i.applyQuaternion(r).round();for(let n=0;n<t.len[0];++n)e.push([t.pos[0]+s.x*n,t.pos[1]+s.y*n,t.pos[2]+s.z*n]);for(let n=1;n<t.len[1];++n)e.push([t.pos[0]+i.x*n,t.pos[1]+i.y*n,t.pos[2]+i.z*n])}}}),e}function Y(h,e,t,s=1){const i=t[0]===0?0:2,r=i===2?e[2]-e[0]-t[0]+1:e[2]-e[0]+1,u=i===2?e[2]-e[0]-1:e[2]+t[2]-e[0]-1,n=i===2?e[2]-e[1]-t[1]+1:e[0]-e[1]-t[1]+1,k=i===2?e[2]-e[1]:e[0]-e[1];h.forEach(m=>{let l=0;const S=m[2]-m[1],D=m[0]-m[1],p=S-D,j=i===2?S:D;m[i]>=e[i]?l=0:n<=j&&j<=k?r<=p&&p<=u?l=3:p+1===r?l=2:p===u+1?l=1:l=0:l=0,s!==1&&(l=3-l),m.length===4?m[3]=l:m.push(l)})}function Ve(h,e,t){let s=X(h.objs);const i=[];let r=-1,u=-1;const n=new N().fromVector3(e),k=new N().fromVector3(t),m=o=>{let d=!1;for(let g=0;g<i.length;++g)if(o.equal(i[g])){d=!0;break}d||(i.push(o),o.equal(n)&&(r=i.length-1),o.equal(k)&&(u=i.length-1))};if(h.mirror!==void 0){Y(s,h.mirror.pos,h.mirror.len,1);const o=X(h.mirror.objs);Y(o,h.mirror.pos,h.mirror.len,0),s=s.concat(o)}const l=[];for(let o=0;o<s.length;++o){let d=!0;const g=s[o][0]-s[o][1],b=s[o][2]-s[o][1],A=s[o][3]||0;if(A!==3){for(let P=0;P<s.length;++P){const T=s[P][0]-s[P][1],O=s[P][2]-s[P][1],M=s[P][3]||0;if(M!==3&&s[P][1]>s[o][1]&&(g===T&&b===O+1&&M<=1&&A!==1||g===T+1&&b===O&&!(M&1)&&A!==2||g===T+1&&b===O+1&&M<3&&(M===0||M===A))){d=!1;break}}d&&l.push(s[o])}}for(let o=0;o<l.length;++o){let d=!1;const g=l[o][3]||0;if(g!==3){if(g>0){for(let b=0;b<l.length;++b)if((l[b][3]||0)+g===3&&l[b][2]-l[b][1]===l[o][2]-l[o][1]&&l[b][0]-l[b][1]===l[o][0]-l[o][1]){d=!0;break}}else d=!0;d&&m(new N().fromArray(l[o]))}}if(r===-1||u===-1)return null;const S=new Array(i.length);for(let o=0;o<S.length;++o)S[o]=[];for(let o=0;o<i.length;++o)for(let d=0;d<i.length;++d)i[o].manhattanDist(i[d])===1&&S[o].push(d);const D=new Array(i.length),p=new Array(i.length),j=new Array(i.length),C=[];for(let o=0;o<i.length;++o)D[o]=!1,p[o]=1061109567,j[o]=-1;D[r]=!0,p[r]=0,C.push(r);let y=0,x=1;for(;y<x;){const o=C[y];y++,D[o]=!1;for(let d=0;d<S[o].length;++d){const g=S[o][d];p[g]>p[o]+1&&(p[g]=p[o]+1,j[g]=o,D[g]||(D[g]=!0,C.push(g),x++))}}if(p[u]===1061109567)return null;{const o=[];let d=u;for(;d!==r;)o.push(i[d].toVector3()),d=j[d];return o.push(n.toVector3()),o.reverse()}}class Be{constructor(e,t=15658734){a(this,"obj");const s=new ue(200,200),i=new pe({color:t});this.obj=new q(s,i),this.obj.rotation.x=-.5*Math.PI,this.obj.position.x=(e[0]||0)+100,this.obj.position.y=e[1],this.obj.position.z=(e[2]||0)+100}translate(e){return this.obj.translateX(e[0]||0),this.obj.translateY(e[1]||0),this.obj.translateZ(e[2]||0),this}rotate(e){return this.obj.rotation.x=e[0]||0,this.obj.rotation.y=e[1]||0,this.obj.rotation.z=e[2]||0,this}}class Ge{constructor(e,t,s,i,r=n=>{console.log(n)},u){a(this,"store",Oe());a(this,"scene");a(this,"camera");a(this,"renderer");a(this,"allCubes",[]);a(this,"draggableObjects",[]);a(this,"uniteDragControl");a(this,"mirror");a(this,"ponder",null);a(this,"tingyun",null);a(this,"startPos");a(this,"destPos",[]);a(this,"walkHint",null);a(this,"nowStage",0);a(this,"animateProgress",-1);a(this,"walkStage",-1);a(this,"route",[]);a(this,"level");a(this,"levelData","");a(this,"particleGeometry",new ge);a(this,"particlePositions",new Float32Array(20*3));a(this,"particle");a(this,"injectMethods");a(this,"appendActions",{});a(this,"appendObjects",{});a(this,"dragEventTime",0);a(this,"mirrorEventTime",0);a(this,"rotateEventTime",0);if(typeof e=="string"?this.level=-1:this.level=e,this.scene=t,this.camera=s,this.renderer=i,typeof e=="string")try{this.setupScene(JSON.parse(atob(e)))}catch(n){r(n)}else Re.get(`/levels/level${this.level}.json`).then(n=>{this.setupScene(n.data)}).catch(n=>{r(n)});this.particleGeometry.setAttribute("position",new fe(this.particlePositions,3)),this.particle=new me(this.particleGeometry,new be({color:16514504,size:10})),this.particle.visible=!1,this.injectMethods=u}check(){if(this.startPos===void 0||this.destPos.length<=this.nowStage)return null;const e=this.nowStage>0?this.destPos[this.nowStage-1]:this.startPos,t=this.destPos[this.nowStage];return Ve({objs:this.allCubes,mirror:this.mirror?{pos:this.mirror.pos,len:this.mirror.len,objs:this.mirror.inMirrorObjs}:void 0},e,t)}parseCode(e){const t=e.split(/\s+/),s={dragTimes:this.dragEventTime,mirrorTimes:this.mirrorEventTime,rotateTimes:this.rotateEventTime};let i;if(!(t.length<=0))switch(t[0]){case"hideHint":this.injectMethods.hideHint();break;case"showHint":this.injectMethods.showHint(t.slice(1).join(" "));break;case"delay":setTimeout(()=>{this.parseCode(t.slice(2).join(" "))},Number((t==null?void 0:t[1])||0)||0);break;case"if":if(i=((t==null?void 0:t[1])||"").match(/([a-zA-Z]+)([<>]=?|=)(\d+)/),i&&i.length===4){const r=i[1],u=i[2],n=Number(i[3]);if(r in s){const k=s[r];let m=!1;switch(u){case"<":m=k<n;break;case"<=":m=k<=n;break;case">":m=k>n;break;case">=":m=k>=n;break;case"=":m=k===n;break}m&&this.parseCode(t.slice(2).join(" "))}}break;case"log":console.log(t);break}}addObject(e){let t,s;switch(e.type){case"Cube":s=new Me(e.pos,e.color),e.name&&(s.name=e.name),this.scene.add(s),this.allCubes.push(s);break;case"Plane":this.scene.add(new Be(e.pos,e.color).obj);break;case"Drawbox":t=new De(e.pos,e.size,e.range,e.color),e.name&&(t.name=e.name),this.scene.add(t),this.allCubes.push(t),this.draggableObjects.push(t);break;case"Rotator":s=new Se(e.pos,e.size,e.color,e.angle,e.direction,e.face),e.name&&(s.name=e.name),this.scene.add(s),this.allCubes.push(s);break}}parseAction(e){const t=e.split(/\n+/);for(const s of t)this.parseCode(s)}parseObjectAction(e){e.forEach(t=>{switch(t.type){case"add":this.addObject(t.obj);break;case"change":if(t.obj.name){const s=this.scene.getObjectByName(t.obj.name);s&&(t.obj.pos&&s.setPosAnimate(t.obj.pos),t.obj.size&&typeof s.setSize=="function"&&s.setSize(t.obj.pos),t.obj.face&&typeof s.setFace=="function"&&s.setFace(t.obj.face),t.obj.range&&typeof s.setRange=="function"&&s.setRange(t.obj.range),t.obj.angle&&typeof s.setAngle=="function"&&s.setAngle(t.obj.angle),t.obj.direction&&typeof s.setDirection=="function"&&s.setDirection(t.obj.direction),t.obj.color&&typeof s.setColor=="function"&&s.setColor(t.obj.color))}break;case"remove":if(t.obj.name){const s=this.scene.getObjectByName(t.obj.name);if(s){let i;i=this.allCubes.findIndex(r=>r.name===t.obj.name),i!==-1&&this.allCubes.splice(i,1),i=this.draggableObjects.findIndex(r=>r.name===t.obj.name),i!==-1&&this.draggableObjects.splice(i,1),this.scene.remove(s)}}break}})}handleEvent(e){e in this.appendActions&&this.parseAction(this.appendActions[e])}handleChangeObjectEvent(e){e in this.appendObjects&&this.parseObjectAction(this.appendObjects[e])}setupScene(e){e.appendActions&&(this.appendActions=e.appendActions),e.appendObjects&&(this.appendObjects=e.appendObjects),this.scene.background=new we(e.background||"#feffbd"),this.startPos=new v().fromArray(e.start),this.destPos=[],e.dests.forEach(t=>{this.destPos.push(new v().fromArray(t))}),this.setupPonder(this.startPos),e.objects.forEach(t=>{this.addObject(t)}),e.mirror&&(this.mirror=new Ae(e.mirror.pos,e.mirror.size,e.mirror.range),this.mirror.setupMirrorCubes(this.allCubes,this.scene),this.scene.add(this.mirror),this.draggableObjects.push(this.mirror)),this.setupDragControls(),this.scene.add(this.particle)}disposeDragControls(){this.uniteDragControl&&this.uniteDragControl.dispose(),this.uniteDragControl=void 0}setupDragControls(){this.disableControls(),this.uniteDragControl=new _e(this.draggableObjects,this.camera,this.renderer.domElement),this.uniteDragControl.addEventListener("dragstart",e=>{let t=e.object;for(;!t.parent.isScene;)t=t.parent;t.onControlDragStart&&t.onControlDragStart(e),t.objectType==="Mirror"?(this.handleEvent("mirror"),this.mirrorEventTime++):(this.handleEvent("drag"),this.dragEventTime++)}),this.uniteDragControl.addEventListener("drag",e=>{let t=e.object;for(;!t.parent.isScene;)t=t.parent;!this.detectCollide(t)&&t.onControlDrag&&t.onControlDrag(e)}),this.uniteDragControl.addEventListener("dragend",e=>{let t=e.object;for(;!t.parent.isScene;)t=t.parent;t.onControlDragEnd&&t.onControlDragEnd(e)})}setupPonder(e){this.store.getPonderModel().then(u=>{const n=te(u);this.ponder=n.scene,this.ponder.scale.set(14.5,14.5,14.5),this.ponder.position.set(e.x*f+f/2+100,(e.y+1)*f+100,e.z*f+f/2+100),this.scene.add(this.ponder)});const t=new ye(6,12,6),s=new I({color:14362664});this.tingyun=new q(t,s),this.tingyun.position.set(this.destPos[0].x*f+f/2,(this.destPos[0].y+1)*f+6,this.destPos[0].z*f+f/2),this.scene.add(this.tingyun);const i=new je(2),r=new I({color:16777215});this.walkHint=new q(i,r),this.walkHint.position.set(e.x*f+f/2,(e.y+1)*f,e.z*f+f/2),this.scene.add(this.walkHint),this.walkHint.visible=!1}updateAnimation(){this.store.updateAnimation()}fixPos(e){return new v(e.x*f+f/2,(e.y+1)*f,e.z*f+f/2)}updatePonder(){if(!(!this.ponder||!this.walkHint||this.animateProgress<=0))if(this.animateProgress>=this.route.length+this.route.length-1)this.animateProgress=-5,this.store.setAnimation("Standing");else{this.animateProgress===this.route.length-1&&(this.animateProgress=this.route.length+1,this.walkHint.visible=!1,this.particle.visible=!1);const e=this.route[this.animateProgress%this.route.length],t=new v().subVectors(e,this.route[this.animateProgress%this.route.length-1]),s=this.animateProgress<this.route.length?this.walkHint:this.ponder,i=this.animateProgress<this.route.length?3:.8;if(this.animateProgress<this.route.length-1){this.walkHint.visible=!0,this.particle.visible=!0;for(let n=0;n<this.particlePositions.length;n+=3)this.particlePositions[n]=s.position.x+Math.random()*2-1,this.particlePositions[n+1]=s.position.y+Math.random()*2-1,this.particlePositions[n+2]=s.position.z+Math.random()*2-1;this.particleGeometry.attributes.position.needsUpdate=!0}else this.store.setAnimation("Running"),t.z>0?this.ponder.rotation.set(0,0,0):t.z<0?this.ponder.rotation.set(0,Math.PI,0):t.x>0?this.ponder.rotation.set(0,Math.PI/2,0):t.x<0&&this.ponder.rotation.set(0,-Math.PI/2,0);s.position.add(t.clone().normalize().multiplyScalar(i));const r=this.fixPos(e);Math.sqrt(Math.pow(s.position.x-s.position.y-r.x+r.y,2)+Math.pow(s.position.z-s.position.y-r.z+r.y,2))<i*2&&this.animateProgress++}}walkRoute(e){this.ponder!==null&&this.walkStage!==this.nowStage&&(e.length<=1||(this.route=e.concat([this.destPos[this.nowStage]]),this.walkStage+=1,this.animateProgress=1,this.disableControls(),this.handleEvent(`finish_${this.nowStage}`)))}enableControls(){this.uniteDragControl&&(this.uniteDragControl.enabled=!0)}disableControls(){this.uniteDragControl&&(this.uniteDragControl.enabled=!1)}nextStage(){if(this.tingyun===null)return!0;if(this.handleChangeObjectEvent(`finish_${this.nowStage}`),this.nowStage+1<this.destPos.length)this.nowStage+=1;else return!1;return this.tingyun.position.set(this.destPos[this.nowStage].x*f+f/2,(this.destPos[this.nowStage].y+1)*f+6,this.destPos[this.nowStage].z*f+f/2),!0}changeCameraAngle(e){const t=new v;switch(e){case 0:t.set(250,250,250);break;case 1:t.set(-250,250,250);break;case 2:t.set(250,250,-250);break;case 3:t.set(-250,250,-250);break}Te({from:this.camera.position,to:t,onUpdate:s=>{this.camera.position.copy(s),this.camera.lookAt(this.scene.position)},duration:1e3})}detectCollide(e){return!1}}const He={},Ne={role:"img",xmlns:"http://www.w3.org/2000/svg",class:"pg-icon",width:"24",height:"24",viewBox:"0 0 24 24","aria-labelledby":"hamburgerIconTitle"},qe=_("title",{id:"hamburgerIconTitle"},"Menu",-1),Fe=_("path",{d:"M6 7L18 7M6 12L18 12M6 17L18 17"},null,-1),$e=[qe,Fe];function We(h,e){return V(),B("svg",Ne,$e)}const Qe=Z(He,[["render",We]]),Ie=h=>(ce("data-v-f4b9b54f"),h=h(),he(),h),Ue=Ie(()=>_("div",{class:"pg-game-container"},[_("canvas",{id:"pg-canvas"})],-1)),Xe=se({__name:"GameView",setup(h){const e=ae(),t=le();let s;const i=z(!1);e.params.id==="custom"&&(i.value=!0);const r=z(Number(e.params.id)||0);document.title=`关卡#${r.value} | Ponder Guy`;const u=z(),n=z(),k=()=>{s.handleEvent("click")},m=z(""),l=z(!1);function S(w){let c=0;l.value&&(l.value=!1,c=300),setTimeout(()=>{l.value=!0,m.value=w},c)}function D(){l.value=!1}const p={width:window.innerWidth,height:window.innerHeight};let j;const C=new ke,y=new Pe(p.width/-16,p.width/16,p.height/16,p.height/-16,-500,2e3);let x;y.position.set(250,250,250),y.lookAt(C.position),y.zoom=2,C.add(y);const o=new Ce(16777215);C.add(o);const d=new xe(16777215,.8);d.position.set(0,100,0),C.add(d);const g={x:0,y:0},b=new Le;let A=!1,P=null,T=!1;const O=w=>{const c=j.getBoundingClientRect();return{x:(w.clientX-c.left)*j.width/c.width,y:(w.clientY-c.top)*j.height/c.height}},M=w=>{const c=O(w);g.x=c.x/j.width*2-1,g.y=c.y/j.height*-2+1,T?(A&&P&&s.animateProgress===-1&&P.onDrag&&P.onDrag(b.raycaster,b.pickedObjectPoint),w.clientX,w.clientY):b.pickedObject},L=()=>{g.x=-1e5,g.y=-1e5,A=!1};L(),window.addEventListener("mousemove",M),window.addEventListener("mouseout",L),window.addEventListener("mouseleave",L),window.addEventListener("touchend",L);const G=()=>{const w=j.getBoundingClientRect();p.height=w.height,p.width=w.width,y.left=p.width/-2,y.right=p.width/2,y.top=p.height/2,y.bottom=p.height/-2,y.left*=.5,y.right*=.5,y.top*=.5,y.bottom*=.5,y.updateProjectionMatrix(),x.setSize(p.width,p.height),x.setPixelRatio(window.devicePixelRatio)},F=w=>{if(A=b.pickedObject!==void 0,T=!0,w.clientX,w.clientY,b.pickedObject&&s.animateProgress===-1){const c=b.pickedObject.parent;c&&c.type==="Group"&&c.movable&&(c.objectType==="Rotator"&&(s.handleEvent("rotate"),s.rotateEventTime++),P=c,c.onDragStart&&c.onDragStart(b.raycaster,b.pickedObjectPoint))}},$=()=>{if(T=!1,P&&s.animateProgress===-1&&P.onDragEnd){P.onDragEnd(b.raycaster,b.pickedObjectPoint);const w=s.check();w!==null&&s.walkRoute(w)}};let R;ie(()=>{j=document.getElementById("pg-canvas"),x=new Ee({canvas:j,antialias:!0,alpha:!0}),x.localClippingEnabled=!0,s=new Ge(i.value?localStorage.levelData:r.value,C,y,x,E=>{alert(E),t.push("/game/list")},{showHint:S,hideHint:D}),b.updateObjs(C.children),R=new ze(y,x.domElement),R.enableRotate=!1,R.zoomToCursor=!0,j.addEventListener("mousedown",F),j.addEventListener("mouseup",$),G(),window.addEventListener("click",k);const w=()=>{setTimeout(()=>{u.value.style.visibility="visible",u.value.style.opacity="1"},200),setTimeout(()=>{n.value.style.opacity="1"},500),setTimeout(()=>{n.value.style.transition="all .2s",n.value.style.opacity="0"},1300),setTimeout(()=>{n.value.innerText="Finish!",n.value.style.opacity="1"},1500),setTimeout(()=>{u.value.style.opacity="0"},3200),setTimeout(()=>{t.replace("/game/list")},4200)},c=()=>{if(requestAnimationFrame(c),s.animateProgress===-5)if(s.animateProgress=-1,s.enableControls(),!s.nextStage())w();else{const E=s.check();E!==null&&s.walkRoute(E)}s.animateProgress!==-1&&s.updatePonder(),s.updateAnimation(),b.pick(new ve(g.x,g.y),C,y),x.render(C,y)};c(),setTimeout(()=>{n.value.style.top="50%",n.value.style.opacity="1"},200),setTimeout(()=>{u.value.style.opacity="0",n.value.style.opacity="0",u.value.style.visibility="hidden",s.handleEvent("init")},2200)}),window.addEventListener("resize",U(G,100));function J(){u.value.style.opacity="1",u.value.style.visibility="visible",setTimeout(()=>{t.replace("/game/list")},1e3)}return oe(()=>{var w;window.removeEventListener("mousemove",M),window.removeEventListener("mouseout",L),window.removeEventListener("mouseleave",L),window.removeEventListener("resize",U(G,100)),window.removeEventListener("click",k),j.removeEventListener("mousedown",F),j.removeEventListener("mouseup",$);try{x.dispose(),x.forceContextLoss();let c=x.domElement.getContext("webgl");c&&c.getExtension("WEBGL_lose_context")&&((w=c.getExtension("WEBGL_lose_context"))==null||w.loseContext()),C.traverse(E=>{E.material&&E.material.dispose(),E.geometry&&E.geometry.dispose(),E=null}),R.dispose()}catch(c){console.error("Failed to destroy threejs",c)}}),(w,c)=>(V(),B(H,null,[_("div",{class:"fog",ref_key:"fog",ref:u},[_("div",{class:"level-show",ref_key:"levelShow",ref:n},[i.value?(V(),B(H,{key:0},[W("自定义关卡")],64)):(V(),B(H,{key:1},[W("Level "+Q(r.value),1)],64))],512)],512),Ue,_("div",{class:"pg-back-button",onClick:c[0]||(c[0]=E=>J())},[ne(Qe)]),_("div",{class:re(["pg-hint",{show:l.value}])},Q(m.value),3)],64))}}),nt=Z(Xe,[["__scopeId","data-v-f4b9b54f"]]);export{nt as default};
