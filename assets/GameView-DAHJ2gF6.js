var te=Object.defineProperty;var ie=(d,e,t)=>e in d?te(d,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):d[e]=t;var l=(d,e,t)=>(ie(d,typeof e!="symbol"?e+"":e,t),t);import{e as B,c as G,b as _,d as se,r as z,o as ne,a as oe,F as H,i as W,t as Q,k as ae,y as re,j as le,u as ce,p as he,f as de}from"./index-D3mIA9Ay.js";import{V as S,Q as ue,a as pe,b as ge,M as F,j as me,r as fe,s as be,t as we,C as ye,c as je,e as I,B as ke,h as U,m as Pe,S as Ce,o as xe,A as Ee,D as Se,d as X,W as ve,q as De,f as Me}from"./index-BSPv5FcJ.js";import{R as Ae,a as _e,C as Le,M as Te,D as ze,u as f,b as Oe,P as Re,O as Be}from"./picker-MAO-0axd.js";import{G as Ge,M as Ve,u as He}from"./index-BNPV7adE.js";import{a as Ne}from"./axios-Bo0ATomq.js";import{_ as J}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./_commonjsHelpers-C4iS2aBk.js";class N{constructor(e,t){l(this,"x");l(this,"y");l(this,"vis",!1);this.x=e||0,this.y=t||0}fromArray(e){return(e.length===3||e.length===4)&&(this.x=-e[1]+e[2],this.y=e[0]-e[1]),this}fromVector3(e){return this.fromArray([e.x,e.y,e.z])}manhattanDist(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)}equal(e,t){return typeof e=="number"&&t!==void 0?this.x===e&&this.y===t:typeof e!="number"?this.x===e.x&&this.y===e.y:!1}toVector3(){return new S(this.y+10,10,this.x+10)}}function Y(d){const e=[];return d.forEach(t=>{if(t.isGroup){let i,s,r;const p=[new S(1,0,0),new S(0,1,0),new S(0,0,1)];switch(t.objectType){case"Cube":e.push([t.pos[0],t.pos[1],t.pos[2]]);break;case"Drawbox":for(let o=0;o<t.len[0];++o)for(let k=0;k<t.len[1];++k)for(let h=0;h<t.len[2];++h)e.push([t.pos[0]+o,t.pos[1]+k,t.pos[2]+h]);break;case"Rotator":i=new S,s=new S,i[t.face[0][1]]=t.face[0][0]==="-"?-1:1,s[t.face[1][1]]=t.face[1][0]==="-"?-1:1,r=new ue().setFromAxisAngle(p[t.direction],t.angle*Math.PI/2),i.applyQuaternion(r).round(),s.applyQuaternion(r).round();for(let o=0;o<t.len[0];++o)e.push([t.pos[0]+i.x*o,t.pos[1]+i.y*o,t.pos[2]+i.z*o]);for(let o=1;o<t.len[1];++o)e.push([t.pos[0]+s.x*o,t.pos[1]+s.y*o,t.pos[2]+s.z*o])}}}),e}function Z(d,e,t,i=1){const s=t[0]===0?0:2,r=s===2?e[2]-e[0]-t[0]+1:e[2]-e[0]+1,p=s===2?e[2]-e[0]-1:e[2]+t[2]-e[0]-1,o=s===2?e[2]-e[1]-t[1]+1:e[0]-e[1]-t[1]+1,k=s===2?e[2]-e[1]:e[0]-e[1];d.forEach(h=>{let a=0;const v=h[2]-h[1],D=h[0]-h[1],g=v-D,j=s===2?v:D;h[s]>=e[s]?a=0:o<=j&&j<=k?r<=g&&g<=p?a=3:g+1===r?a=2:g===p+1?a=1:a=0:a=0,i!==1&&(a=3-a),h.length===4?h[3]=a:h.push(a)})}function Fe(d,e,t){let i=Y(d.objs);const s=[];let r=-1,p=-1;const o=new N().fromVector3(e),k=new N().fromVector3(t),h=n=>{let u=!1;for(let m=0;m<s.length;++m)if(n.equal(s[m])){u=!0;break}u||(s.push(n),n.equal(o)&&(r=s.length-1),n.equal(k)&&(p=s.length-1))};if(d.mirror!==void 0){Z(i,d.mirror.pos,d.mirror.len,1);const n=Y(d.mirror.objs);Z(n,d.mirror.pos,d.mirror.len,0),i=i.concat(n)}const a=[];for(let n=0;n<i.length;++n){let u=!0;const m=i[n][0]-i[n][1],b=i[n][2]-i[n][1],A=i[n][3]||0;if(A!==3){for(let P=0;P<i.length;++P){const L=i[P][0]-i[P][1],O=i[P][2]-i[P][1],M=i[P][3]||0;if(M!==3&&i[P][1]>i[n][1]&&(m===L&&b===O+1&&M<=1&&A!==1||m===L+1&&b===O&&!(M&1)&&A!==2||m===L+1&&b===O+1&&M<3&&(M===0||M===A))){u=!1;break}}u&&a.push(i[n])}}for(let n=0;n<a.length;++n){let u=!1;const m=a[n][3]||0;if(m!==3){if(m>0){for(let b=0;b<a.length;++b)if((a[b][3]||0)+m===3&&a[b][2]-a[b][1]===a[n][2]-a[n][1]&&a[b][0]-a[b][1]===a[n][0]-a[n][1]){u=!0;break}}else u=!0;u&&h(new N().fromArray(a[n]))}}if(r===-1||p===-1)return null;const v=new Array(s.length);for(let n=0;n<v.length;++n)v[n]=[];for(let n=0;n<s.length;++n)for(let u=0;u<s.length;++u)s[n].manhattanDist(s[u])===1&&v[n].push(u);const D=new Array(s.length),g=new Array(s.length),j=new Array(s.length),C=[];for(let n=0;n<s.length;++n)D[n]=!1,g[n]=1061109567,j[n]=-1;D[r]=!0,g[r]=0,C.push(r);let y=0,x=1;for(;y<x;){const n=C[y];y++,D[n]=!1;for(let u=0;u<v[n].length;++u){const m=v[n][u];g[m]>g[n]+1&&(g[m]=g[n]+1,j[m]=n,D[m]||(D[m]=!0,C.push(m),x++))}}if(g[p]===1061109567)return null;{const n=[];let u=p;for(;u!==r;)n.push(s[u].toVector3()),u=j[u];return n.push(o.toVector3()),n.reverse()}}class qe{constructor(e,t=15658734){l(this,"obj");const i=new pe(200,200),s=new ge({color:t});this.obj=new F(i,s),this.obj.rotation.x=-.5*Math.PI,this.obj.position.x=(e[0]||0)+100,this.obj.position.y=e[1],this.obj.position.z=(e[2]||0)+100}translate(e){return this.obj.translateX(e[0]||0),this.obj.translateY(e[1]||0),this.obj.translateZ(e[2]||0),this}rotate(e){return this.obj.rotation.x=e[0]||0,this.obj.rotation.y=e[1]||0,this.obj.rotation.z=e[2]||0,this}}class $e{constructor(e,t,i,s,r=o=>{console.log(o)},p){l(this,"scene");l(this,"camera");l(this,"renderer");l(this,"allCubes",[]);l(this,"draggableObjects",[]);l(this,"uniteDragControl");l(this,"mirror");l(this,"ponder",null);l(this,"tingyun",null);l(this,"startPos");l(this,"destPos",[]);l(this,"walkHint",null);l(this,"nowStage",0);l(this,"animateProgress",-1);l(this,"walkStage",-1);l(this,"route",[]);l(this,"level");l(this,"levelData","");l(this,"animation");l(this,"particleGeometry",new me);l(this,"particlePositions",new Float32Array(20*3));l(this,"particle");l(this,"injectMethods");l(this,"appendActions",{});l(this,"appendObjects",{});l(this,"dragEventTime",0);l(this,"mirrorEventTime",0);l(this,"rotateEventTime",0);if(typeof e=="string"?this.level=-1:this.level=e,this.scene=t,this.camera=i,this.renderer=s,typeof e=="string")try{this.setupScene(JSON.parse(atob(e)))}catch(o){r(o)}else Ne.get(`/levels/level${this.level}.json`).then(o=>{this.setupScene(o.data)}).catch(o=>{r(o)});this.particleGeometry.setAttribute("position",new fe(this.particlePositions,3)),this.particle=new be(this.particleGeometry,new we({color:16514504,size:10})),this.particle.visible=!1,this.injectMethods=p}check(){if(this.startPos===void 0||this.destPos.length<=this.nowStage)return null;const e=this.nowStage>0?this.destPos[this.nowStage-1]:this.startPos,t=this.destPos[this.nowStage];return Fe({objs:this.allCubes,mirror:this.mirror?{pos:this.mirror.pos,len:this.mirror.len,objs:this.mirror.inMirrorObjs}:void 0},e,t)}parseCode(e){const t=e.split(/\s+/),i={dragTimes:this.dragEventTime,mirrorTimes:this.mirrorEventTime,rotateTimes:this.rotateEventTime};let s;if(!(t.length<=0))switch(t[0]){case"hideHint":this.injectMethods.hideHint();break;case"showHint":this.injectMethods.showHint(t.slice(1).join(" "));break;case"delay":setTimeout(()=>{this.parseCode(t.slice(2).join(" "))},Number((t==null?void 0:t[1])||0)||0);break;case"if":if(s=((t==null?void 0:t[1])||"").match(/([a-zA-Z]+)([<>]=?|=)(\d+)/),s&&s.length===4){const r=s[1],p=s[2],o=Number(s[3]);if(r in i){const k=i[r];let h=!1;switch(p){case"<":h=k<o;break;case"<=":h=k<=o;break;case">":h=k>o;break;case">=":h=k>=o;break;case"=":h=k===o;break}h&&this.parseCode(t.slice(2).join(" "))}}break;case"log":console.log(t);break}}addObject(e){let t,i;switch(e.type){case"Cube":i=new Le(e.pos,e.color),e.name&&(i.name=e.name),this.scene.add(i),this.allCubes.push(i);break;case"Plane":this.scene.add(new qe(e.pos,e.color).obj);break;case"Drawbox":t=new _e(e.pos,e.size,e.range,e.color),e.name&&(t.name=e.name),this.scene.add(t),this.allCubes.push(t),this.draggableObjects.push(t);break;case"Rotator":i=new Ae(e.pos,e.size,e.color,e.angle,e.direction,e.face),e.name&&(i.name=e.name),this.scene.add(i),this.allCubes.push(i);break}}parseAction(e){const t=e.split(/\n+/);for(const i of t)this.parseCode(i)}parseObjectAction(e){e.forEach(t=>{switch(t.type){case"add":this.addObject(t.obj);break;case"change":if(t.obj.name){const i=this.scene.getObjectByName(t.obj.name);i&&(t.obj.pos&&i.setPosAnimate(t.obj.pos),t.obj.size&&typeof i.setSize=="function"&&i.setSize(t.obj.pos),t.obj.face&&typeof i.setFace=="function"&&i.setFace(t.obj.face),t.obj.range&&typeof i.setRange=="function"&&i.setRange(t.obj.range),t.obj.angle&&typeof i.setAngle=="function"&&i.setAngle(t.obj.angle),t.obj.direction&&typeof i.setDirection=="function"&&i.setDirection(t.obj.direction),t.obj.color&&typeof i.setColor=="function"&&i.setColor(t.obj.color))}break;case"remove":if(t.obj.name){const i=this.scene.getObjectByName(t.obj.name);if(i){let s;s=this.allCubes.findIndex(r=>r.name===t.obj.name),s!==-1&&this.allCubes.splice(s,1),s=this.draggableObjects.findIndex(r=>r.name===t.obj.name),s!==-1&&this.draggableObjects.splice(s,1),this.scene.remove(i)}}break}})}handleEvent(e){e in this.appendActions&&this.parseAction(this.appendActions[e])}handleChangeObjectEvent(e){e in this.appendObjects&&this.parseObjectAction(this.appendObjects[e])}setupScene(e){e.appendActions&&(this.appendActions=e.appendActions),e.appendObjects&&(this.appendObjects=e.appendObjects),this.scene.background=new ye(e.background||"#feffbd"),this.startPos=new S().fromArray(e.start),this.destPos=[],e.dests.forEach(t=>{this.destPos.push(new S().fromArray(t))}),this.setupPonder(this.startPos),e.objects.forEach(t=>{this.addObject(t)}),e.mirror&&(this.mirror=new Te(e.mirror.pos,e.mirror.size,e.mirror.range),this.mirror.setupMirrorCubes(this.allCubes,this.scene),this.scene.add(this.mirror),this.draggableObjects.push(this.mirror)),this.setupDragControls(),this.scene.add(this.particle)}disposeDragControls(){this.uniteDragControl&&this.uniteDragControl.dispose(),this.uniteDragControl=void 0}setupDragControls(){this.disableControls(),this.uniteDragControl=new ze(this.draggableObjects,this.camera,this.renderer.domElement),this.uniteDragControl.addEventListener("dragstart",e=>{let t=e.object;for(;!t.parent.isScene;)t=t.parent;t.onControlDragStart&&t.onControlDragStart(e),t.objectType==="Mirror"?(this.handleEvent("mirror"),this.mirrorEventTime++):(this.handleEvent("drag"),this.dragEventTime++)}),this.uniteDragControl.addEventListener("drag",e=>{let t=e.object;for(;!t.parent.isScene;)t=t.parent;!this.detachCollide(t)&&t.onControlDrag?t.onControlDrag(e):t.setPos(t.pos)}),this.uniteDragControl.addEventListener("dragend",e=>{let t=e.object;for(;!t.parent.isScene;)t=t.parent;t.onControlDragEnd&&t.onControlDragEnd(e)})}setupPonder(e){const t=new Ge;t.setMeshoptDecoder(Ve),He().getPonder().then(k=>{t.parse(k,"/",h=>{this.ponder=h.scene,this.ponder.scale.set(14.5,14.5,14.5),this.ponder.position.set(e.x*f+f/2+100,(e.y+1)*f+100,e.z*f+f/2+100),this.scene.add(this.ponder);const a=new je(this.ponder);this.animation={mixer:a,animations:{Running:a.clipAction(I.findByName(h.animations,"Running")),Standing:a.clipAction(I.findByName(h.animations,"Standing"))}},this.animation.animations.Running.play(),this.animation.animations.Running.weight=0,this.animation.animations.Standing.play(),this.animation.animations.Standing.weight=1})});const s=new ke(6,12,6),r=new U({color:14362664});this.tingyun=new F(s,r),this.tingyun.position.set(this.destPos[0].x*f+f/2,(this.destPos[0].y+1)*f+6,this.destPos[0].z*f+f/2),this.scene.add(this.tingyun);const p=new Pe(2),o=new U({color:16777215});this.walkHint=new F(p,o),this.walkHint.position.set(e.x*f+f/2,(e.y+1)*f,e.z*f+f/2),this.scene.add(this.walkHint),this.walkHint.visible=!1}updateAnimation(e){this.animation&&this.animation.mixer.update(e)}fixPos(e){return new S(e.x*f+f/2,(e.y+1)*f,e.z*f+f/2)}updatePonder(){if(!(!this.ponder||!this.walkHint||this.animateProgress<=0))if(this.animateProgress>=this.route.length+this.route.length-1)this.animateProgress=-5,this.animation.animations.Running.weight=0,this.animation.animations.Standing.weight=1;else{this.animateProgress===this.route.length-1&&(this.animateProgress=this.route.length+1,this.walkHint.visible=!1,this.particle.visible=!1);const e=this.route[this.animateProgress%this.route.length],t=new S().subVectors(e,this.route[this.animateProgress%this.route.length-1]),i=this.animateProgress<this.route.length?this.walkHint:this.ponder,s=this.animateProgress<this.route.length?3:.8;if(this.animateProgress<this.route.length-1){this.walkHint.visible=!0,this.particle.visible=!0;for(let o=0;o<this.particlePositions.length;o+=3)this.particlePositions[o]=i.position.x+Math.random()*2-1,this.particlePositions[o+1]=i.position.y+Math.random()*2-1,this.particlePositions[o+2]=i.position.z+Math.random()*2-1;this.particleGeometry.attributes.position.needsUpdate=!0}else this.animation.animations.Running.weight=1,this.animation.animations.Standing.weight=0,t.z>0?this.ponder.rotation.set(0,0,0):t.z<0?this.ponder.rotation.set(0,Math.PI,0):t.x>0?this.ponder.rotation.set(0,Math.PI/2,0):t.x<0&&this.ponder.rotation.set(0,-Math.PI/2,0);i.position.add(t.clone().normalize().multiplyScalar(s));const r=this.fixPos(e);Math.sqrt(Math.pow(i.position.x-i.position.y-r.x+r.y,2)+Math.pow(i.position.z-i.position.y-r.z+r.y,2))<s*2&&this.animateProgress++}}walkRoute(e){this.ponder!==null&&this.walkStage!==this.nowStage&&(e.length<=1||(this.route=e.concat([this.destPos[this.nowStage]]),this.walkStage+=1,this.animateProgress=1,this.disableControls(),this.handleEvent(`finish_${this.nowStage}`)))}enableControls(){this.uniteDragControl&&(this.uniteDragControl.enabled=!0)}disableControls(){this.uniteDragControl&&(this.uniteDragControl.enabled=!1)}nextStage(){if(this.tingyun===null)return!0;if(this.handleChangeObjectEvent(`finish_${this.nowStage}`),this.nowStage+1<this.destPos.length)this.nowStage+=1;else return!1;return this.tingyun.position.set(this.destPos[this.nowStage].x*f+f/2,(this.destPos[this.nowStage].y+1)*f+6,this.destPos[this.nowStage].z*f+f/2),!0}changeCameraAngle(e){const t=new S;switch(e){case 0:t.set(250,250,250);break;case 1:t.set(-250,250,250);break;case 2:t.set(250,250,-250);break;case 3:t.set(-250,250,-250);break}Oe({from:this.camera.position,to:t,onUpdate:i=>{this.camera.position.copy(i),this.camera.lookAt(this.scene.position)},duration:1e3})}detachCollide(e){return!1}}const We={},Qe={role:"img",xmlns:"http://www.w3.org/2000/svg",class:"pg-icon",width:"24",height:"24",viewBox:"0 0 24 24","aria-labelledby":"hamburgerIconTitle"},Ie=_("title",{id:"hamburgerIconTitle"},"Menu",-1),Ue=_("path",{d:"M6 7L18 7M6 12L18 12M6 17L18 17"},null,-1),Xe=[Ie,Ue];function Ye(d,e){return B(),G("svg",Qe,Xe)}const Ze=J(We,[["render",Ye]]),Je=d=>(he("data-v-bff3b5af"),d=d(),de(),d),Ke=Je(()=>_("div",{class:"pg-game-container"},[_("canvas",{id:"pg-canvas"})],-1)),et=se({__name:"GameView",setup(d){const e=le(),t=ce();let i;const s=z(!1);e.params.id==="custom"&&(s.value=!0);const r=z(Number(e.params.id)||0);document.title=`关卡#${r.value} | Ponder Guy`;const p=z(),o=z(),k=()=>{i.handleEvent("click")},h=z(""),a=z(!1);function v(w){let c=0;a.value&&(a.value=!1,c=300),setTimeout(()=>{a.value=!0,h.value=w},c)}function D(){a.value=!1}const g={width:window.innerWidth,height:window.innerHeight};let j;const C=new Ce,y=new xe(g.width/-16,g.width/16,g.height/16,g.height/-16,-500,2e3);let x;y.position.set(250,250,250),y.lookAt(C.position),y.zoom=2,C.add(y);const n=new Ee(16777215);C.add(n);const u=new Se(16777215,.8);u.position.set(0,100,0),C.add(u);const m={x:0,y:0},b=new Re;let A=!1,P=null,L=!1;const O=w=>{const c=j.getBoundingClientRect();return{x:(w.clientX-c.left)*j.width/c.width,y:(w.clientY-c.top)*j.height/c.height}},M=w=>{const c=O(w);m.x=c.x/j.width*2-1,m.y=c.y/j.height*-2+1,L?(A&&P&&i.animateProgress===-1&&P.onDrag&&P.onDrag(b.raycaster,b.pickedObjectPoint),w.clientX,w.clientY):b.pickedObject},T=()=>{m.x=-1e5,m.y=-1e5,A=!1};T(),window.addEventListener("mousemove",M),window.addEventListener("mouseout",T),window.addEventListener("mouseleave",T),window.addEventListener("touchend",T);const V=()=>{const w=j.getBoundingClientRect();g.height=w.height,g.width=w.width,y.left=g.width/-2,y.right=g.width/2,y.top=g.height/2,y.bottom=g.height/-2,y.left*=.5,y.right*=.5,y.top*=.5,y.bottom*=.5,y.updateProjectionMatrix(),x.setSize(g.width,g.height),x.setPixelRatio(window.devicePixelRatio)},K=new Me,q=w=>{if(A=b.pickedObject!==void 0,L=!0,w.clientX,w.clientY,b.pickedObject&&i.animateProgress===-1){const c=b.pickedObject.parent;c&&c.type==="Group"&&c.movable&&(c.objectType==="Rotator"&&(i.handleEvent("rotate"),i.rotateEventTime++),P=c,c.onDragStart&&c.onDragStart(b.raycaster,b.pickedObjectPoint))}},$=()=>{if(L=!1,P&&i.animateProgress===-1&&P.onDragEnd){P.onDragEnd(b.raycaster,b.pickedObjectPoint);const w=i.check();w!==null&&i.walkRoute(w)}};let R;ne(()=>{j=document.getElementById("pg-canvas"),x=new ve({canvas:j,antialias:!0,alpha:!0}),x.localClippingEnabled=!0,i=new $e(s.value?localStorage.levelData:r.value,C,y,x,E=>{alert(E),t.push("/game/list")},{showHint:v,hideHint:D}),b.updateObjs(C.children),R=new Be(y,x.domElement),R.enableRotate=!1,R.zoomToCursor=!0,j.addEventListener("mousedown",q),j.addEventListener("mouseup",$),V(),window.addEventListener("click",k);const w=()=>{setTimeout(()=>{p.value.style.visibility="visible",p.value.style.opacity="1"},200),setTimeout(()=>{o.value.style.opacity="1"},500),setTimeout(()=>{o.value.style.transition="all .2s",o.value.style.opacity="0"},1300),setTimeout(()=>{o.value.innerText="Finish!",o.value.style.opacity="1"},1500),setTimeout(()=>{p.value.style.opacity="0"},3200),setTimeout(()=>{t.replace("/game/list")},4200)},c=()=>{if(requestAnimationFrame(c),i.animateProgress===-5)if(i.animateProgress=-1,i.enableControls(),!i.nextStage())w();else{const E=i.check();E!==null&&i.walkRoute(E)}i.animateProgress!==-1&&i.updatePonder(),i.updateAnimation(K.getDelta()),b.pick(new De(m.x,m.y),C,y),x.render(C,y)};c(),setTimeout(()=>{o.value.style.top="50%",o.value.style.opacity="1"},200),setTimeout(()=>{p.value.style.opacity="0",o.value.style.opacity="0",p.value.style.visibility="hidden",i.handleEvent("init")},2200)}),window.addEventListener("resize",X(V,100));function ee(){p.value.style.opacity="1",p.value.style.visibility="visible",setTimeout(()=>{t.replace("/game/list")},1e3)}return oe(()=>{var w;window.removeEventListener("mousemove",M),window.removeEventListener("mouseout",T),window.removeEventListener("mouseleave",T),window.removeEventListener("resize",X(V,100)),window.removeEventListener("click",k),j.removeEventListener("mousedown",q),j.removeEventListener("mouseup",$);try{x.dispose(),x.forceContextLoss();let c=x.domElement.getContext("webgl");c&&c.getExtension("WEBGL_lose_context")&&((w=c.getExtension("WEBGL_lose_context"))==null||w.loseContext()),C.traverse(E=>{E.material&&E.material.dispose(),E.geometry&&E.geometry.dispose(),E=null}),R.dispose()}catch(c){console.error("Failed to destroy threejs",c)}}),(w,c)=>(B(),G(H,null,[_("div",{class:"fog",ref_key:"fog",ref:p},[_("div",{class:"level-show",ref_key:"levelShow",ref:o},[s.value?(B(),G(H,{key:0},[W("自定义关卡")],64)):(B(),G(H,{key:1},[W("Level "+Q(r.value),1)],64))],512)],512),Ke,_("div",{class:"pg-back-button",onClick:c[0]||(c[0]=E=>ee())},[ae(Ze)]),_("div",{class:re(["pg-hint",{show:a.value}])},Q(h.value),3)],64))}}),ht=J(et,[["__scopeId","data-v-bff3b5af"]]);export{ht as default};
